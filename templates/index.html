<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Buy or Rent?</title>
    <meta name="description" content="Month-by-month buy vs rent break-even simulator (variable/fixed mortgage rates, real vs nominal dollars).">
    <meta property="og:title" content="Buy or Rent?">
    <meta property="og:description" content="Month-by-month break-even simulation with variable/fixed mortgage rates and real vs nominal reporting.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:image" content="{{ url_for('og_image', _external=True) }}">
    <meta property="og:image:type" content="image/svg+xml">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Buy or Rent?">
    <meta name="twitter:description" content="Month-by-month break-even simulation with variable/fixed mortgage rates and real vs nominal reporting.">
    <meta name="twitter:image" content="{{ url_for('og_image', _external=True) }}">
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20100%20100%27%3E%3Crect%20width%3D%27100%27%20height%3D%27100%27%20rx%3D%2720%27%20fill%3D%27%231652f0%27/%3E%3Cg%20fill%3D%27%23fff%27%3E%3Crect%20x%3D%2712%27%20y%3D%2746%27%20width%3D%2718%27%20height%3D%2742%27%20rx%3D%272%27/%3E%3Crect%20x%3D%2733%27%20y%3D%2730%27%20width%3D%2722%27%20height%3D%2758%27%20rx%3D%272%27/%3E%3Crect%20x%3D%2758%27%20y%3D%2740%27%20width%3D%2730%27%20height%3D%2748%27%20rx%3D%272%27/%3E%3Crect%20x%3D%2739%27%20y%3D%2722%27%20width%3D%2710%27%20height%3D%276%27%20rx%3D%271%27/%3E%3C/g%3E%3Cg%20fill%3D%27%231652f0%27%3E%3Crect%20x%3D%2717%27%20y%3D%2752%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2722%27%20y%3D%2752%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2717%27%20y%3D%2758%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2722%27%20y%3D%2758%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2738%27%20y%3D%2736%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2743%27%20y%3D%2736%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2748%27%20y%3D%2736%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2738%27%20y%3D%2742%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2743%27%20y%3D%2742%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2748%27%20y%3D%2742%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2738%27%20y%3D%2748%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2743%27%20y%3D%2748%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2748%27%20y%3D%2748%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2765%27%20y%3D%2746%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2770%27%20y%3D%2746%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2775%27%20y%3D%2746%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2765%27%20y%3D%2752%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2770%27%20y%3D%2752%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3Crect%20x%3D%2775%27%20y%3D%2752%27%20width%3D%273%27%20height%3D%273%27%20rx%3D%270.6%27/%3E%3C/g%3E%3C/svg%3E">
    <style>
      *, *::before, *::after { box-sizing: border-box; }
      html, body { overflow-x: hidden; }
      body { font-family: Arial, sans-serif; margin: 32px; max-width: 960px; }
      h1 { margin-bottom: 8px; }
      p.lead { margin-top: 0; color: #444; }
      ul.key-points { margin-top: 0; }
      .section { margin: 12px 0 20px; }
      form { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px 16px; }
      fieldset { border: 1px solid #ddd; padding: 12px; border-radius: 6px; background: #fafafa; min-width: 0; }
      legend { font-weight: 700; padding: 0 6px; }
      .group { grid-column: 1 / -1; }
      label { display: block; font-weight: 600; margin-bottom: 4px; }
      input { width: 100%; max-width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
      .input-row { display: flex; gap: 10px; align-items: stretch; }
      .input-row > * { min-width: 0; }
      .input-pct { flex: 0 0 140px; }
      .input-pct input { text-align: right; }
      .field-hint { color: #666; font-size: 12px; margin-top: 4px; }
      .chip { display: inline-block; padding: 2px 6px; border-radius: 999px; font-size: 12px; font-weight: 700; margin-left: 6px; }
      .chip-owner { background: #e6edff; color: #1236a3; border: 1px solid #c5d5ff; }
      .chip-renter { background: #e5f7ec; color: #186a3b; border: 1px solid #c2e8d0; }
      .chip-both { background: #f3f3f3; color: #444; border: 1px solid #d8d8d8; }
      .row { grid-column: 1 / -1; }
      .error { color: #b30000; font-weight: 600; }
      .field-error { color: #b30000; font-weight: 600; font-size: 13px; margin-top: 4px; }
      .result { margin-top: 16px; padding: 16px; background: #f5f5f5; border-radius: 6px; border: 1px solid #e6e6e6; }
      .pill-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 12px; }
      .pill { background: white; border: 1px solid #dcdcdc; border-radius: 6px; padding: 12px; }
      .pill-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.03em; color: #666; margin-bottom: 4px; }
      .table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 6px; }
      .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      .table th, .table td { border: 1px solid #ddd; padding: 6px 8px; text-align: right; font-variant-numeric: tabular-nums; }
      .table th { text-align: left; background: #f0f0f0; }
      .helper { color: #444; font-size: 14px; margin: 4px 0 0; }
      .inline-code { font-family: Menlo, Consolas, monospace; background: #f0f0f0; padding: 2px 4px; border-radius: 4px; }
      button { padding: 10px 16px; font-size: 16px; border: none; background: #1652f0; color: white; border-radius: 6px; cursor: pointer; }
      button:hover { background: #0f3db3; }
      .muted { color: #555; }
      .segmented { display: inline-flex; border: 1px solid #cfcfcf; border-radius: 8px; overflow: hidden; background: white; }
      .segmented input { position: absolute; opacity: 0; pointer-events: none; }
      .segmented label { margin: 0; padding: 10px 12px; font-weight: 700; cursor: pointer; user-select: none; border-right: 1px solid #e2e2e2; white-space: nowrap; }
      .segmented label:last-child { border-right: none; }
      .segmented input:checked + label { background: #1652f0; color: white; border-right-color: #1652f0; }
      .segmented label:hover { background: #f3f6ff; }
      .segmented input:checked + label:hover { background: #1652f0; }
      .hide { display: none; }

      @media (max-width: 640px) {
        body { margin: 16px; }
        form { grid-template-columns: 1fr; gap: 10px; }
        fieldset { padding: 10px; }
        .section { margin: 10px 0 16px; }
        .pill-grid { grid-template-columns: 1fr; }
        .segmented { width: 100%; }
        .segmented label { flex: 1; text-align: center; white-space: normal; }
        button { width: 100%; }
        .table th, .table td { padding: 6px 6px; }
      }
    </style>
  </head>
  <body>
    <h1>Buy or Rent?</h1>
    <p class="lead">Enter your assumptions, run the month-by-month simulation, and see when owning equals renting (after accounting for home equity vs. invested cash while renting).</p>
    <div class="section">
      <strong>How it works</strong>
      <ul class="key-points">
        <li>Every month we compare owner costs (mortgage + carrying costs) to rent. The cheaper side invests the difference at your investment return.</li>
        <li>Your down payment and buy closing costs stay invested while renting; home value and mortgage balance track owner equity.</li>
        <li>Break-even occurs when owner net worth (home equity + any invested savings) catches up to the renterâ€™s portfolio in real or nominal dollars.</li>
      </ul>
      <div class="helper">Tip: use the rate schedule format <span class="inline-code">start_month:annual_rate</span> (e.g., <span class="inline-code">0:0.065,24:0.075,60:0.060</span>) for variable mortgages. Chips mark whether an input impacts the Owner, Renter, or Both.</div>
    </div>
    <form id="sim-form" method="POST" action="{{ url_for('index') }}">
      {% for group in groups %}
        <fieldset class="group">
          <legend>{{ group.title }} {% if group.scope %}<span class="chip chip-{{ group.scope|lower }}">{{ group.scope }}</span>{% endif %}</legend>
          {% if group.description %}<div class="helper" style="margin-bottom: 8px;">{{ group.description }}</div>{% endif %}
          {% for field in group.fields %}
            <div>
              <label for="{{ field.name }}">{{ field.label }} <span class="chip chip-{{ field.scope|lower }}">{{ field.scope }}</span></label>
              {% if field.name == 'down_payment' %}
                <div class="input-row">
                  <div style="flex: 1 1 auto;">
                    <input type="text" id="down_payment" name="down_payment" inputmode="decimal" value="{{ request.form.get('down_payment', field.value) }}">
                    {% if field_errors and field_errors.get('down_payment') %}<div class="field-error">{{ field_errors.get('down_payment') }}</div>{% endif %}
                    <div class="field-hint">Enter either $ or % (syncs to purchase price).</div>
                  </div>
                  <div class="input-pct">
                    <input type="text" id="down_payment_pct" name="down_payment_pct" inputmode="decimal" value="">
                  </div>
                </div>
              {% else %}
                <input type="text" id="{{ field.name }}" name="{{ field.name }}" value="{{ request.form.get(field.name, field.value) }}">
              {% endif %}
              {% if field.name != 'down_payment' and field_errors and field_errors.get(field.name) %}<div class="field-error">{{ field_errors.get(field.name) }}</div>{% endif %}
            </div>
          {% endfor %}
        </fieldset>
      {% endfor %}
      <fieldset class="group">
        <legend>Mortgage Rate <span class="chip chip-owner">Owner</span></legend>
        <div class="row">
          <label>Mode</label>
          <div class="segmented" role="radiogroup" aria-label="Mortgage rate mode">
            <input type="radio" id="rate_mode_variable" name="rate_mode" value="variable" {% if request.form.get('rate_mode', 'variable') == 'variable' %}checked{% endif %}>
            <label for="rate_mode_variable">Variable</label>
            <input type="radio" id="rate_mode_fixed" name="rate_mode" value="fixed" {% if request.form.get('rate_mode') == 'fixed' %}checked{% endif %}>
            <label for="rate_mode_fixed">Fixed</label>
          </div>
          <div class="helper" style="margin-top: 6px;">If you switch modes, only the visible inputs are used.</div>
        </div>
        <div id="fixed_rate_block">
          <label for="fixed_mortgage_rate">Fixed mortgage rate (annual decimal)</label>
          <input type="text" id="fixed_mortgage_rate" name="fixed_mortgage_rate" inputmode="decimal" value="{{ request.form.get('fixed_mortgage_rate', '') }}">
          {% if field_errors and field_errors.get('fixed_mortgage_rate') %}<div class="field-error">{{ field_errors.get('fixed_mortgage_rate') }}</div>{% endif %}
        </div>
        <div id="variable_rate_block">
          <label for="variable_rate_schedule">Variable rate schedule (start_month:annual_rate)</label>
          <input type="text" id="variable_rate_schedule" name="variable_rate_schedule" value="{{ request.form.get('variable_rate_schedule', '0:0.065,24:0.075,60:0.060') }}">
          {% if field_errors and field_errors.get('variable_rate_schedule') %}<div class="field-error">{{ field_errors.get('variable_rate_schedule') }}</div>{% endif %}
        </div>
      </fieldset>
      <fieldset class="group">
        <legend>Reporting</legend>
        <div class="segmented" role="radiogroup" aria-label="Reporting mode">
          <input type="radio" id="report_mode_real" name="report_mode" value="real" {% if request.form.get('report_mode', 'real') == 'real' %}checked{% endif %}>
          <label for="report_mode_real">Real (inflation-adjusted)</label>
          <input type="radio" id="report_mode_nominal" name="report_mode" value="nominal" {% if request.form.get('report_mode') == 'nominal' %}checked{% endif %}>
          <label for="report_mode_nominal">Nominal</label>
        </div>
      </fieldset>
      {% if error %}<div class="row error" style="margin-top: 6px;">{{ error }}</div>{% endif %}
      <div class="row">
        <button type="submit">Run simulation</button>
      </div>
    </form>

    <div id="results"></div>
    {% if result %}
      <div class="result">
        <h2 style="margin: 0 0 8px 0;">Results</h2>
        {% if result.break_even_month is not none %}
          <div><strong>Break-even:</strong> month {{ result.break_even_month }} (~{{ "%.2f"|format(result.break_even_years) }} years) comparing {{ "real" if result.used_real_dollars else "nominal" }} dollars.</div>
        {% else %}
          <div><strong>No break-even within horizon.</strong> Owner never catches renter under these assumptions.</div>
        {% endif %}
        <div class="pill-grid">
          <div class="pill">
            <div class="pill-label">Upfront cash to buy</div>
            <div>${{ "{:,.0f}".format(result.assumptions.upfront_buy_cash) }}</div>
            <div class="helper">Includes down payment + closing (${{ "{:,.0f}".format(result.assumptions.buy_closing_cost) }})</div>
          </div>
          <div class="pill">
            <div class="pill-label">Mortgage rate mode</div>
            <div>{% if request.form.get('fixed_mortgage_rate') %}Fixed @ {{ request.form.get('fixed_mortgage_rate') }}{% else %}Variable schedule{% endif %}</div>
            <div class="helper">{% if request.form.get('fixed_mortgage_rate') %}Fixed rate overrides schedule{% else %}{{ request.form.get('variable_rate_schedule', '0:0.065,24:0.075,60:0.060') }}{% endif %}</div>
          </div>
          <div class="pill">
            <div class="pill-label">Comparison dollars</div>
            <div>{{ "Inflation-adjusted (real)" if result.used_real_dollars else "Nominal" }}</div>
            <div class="helper">Toggle under Reporting</div>
          </div>
          {% if breakeven_row %}
            <div class="pill">
              <div class="pill-label">Net worth at break-even</div>
              <div>Owner ${{ "{:,.0f}".format(breakeven_row.nw_buy) }} | Renter ${{ "{:,.0f}".format(breakeven_row.nw_rent) }}</div>
              <div class="helper">Home value ${{ "{:,.0f}".format(breakeven_row.home_value) }} | Mortgage balance ${{ "{:,.0f}".format(breakeven_row.mortgage_balance) }}</div>
            </div>
          {% endif %}
        </div>
        {% if checkpoints %}
          <div style="margin-top: 12px; font-weight: 700;">Yearly checkpoints (real/nominal matches your reporting choice)</div>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Rate</th>
                  <th>Owner outflow</th>
                  <th>Rent</th>
                  <th>Owner net worth</th>
                  <th>Renter net worth</th>
                  <th>Home value</th>
                  <th>Mortgage bal.</th>
                </tr>
              </thead>
              <tbody>
                {% for row in checkpoints %}
                  <tr>
                    <td>{{ row.month }}</td>
                    <td>{{ "%.3f"|format(row.mortgage_rate) }}</td>
                    <td>${{ "{:,.0f}".format(row.owner_outflow) }}</td>
                    <td>${{ "{:,.0f}".format(row.rent) }}</td>
                    <td>${{ "{:,.0f}".format(row.nw_buy) }}</td>
                    <td>${{ "{:,.0f}".format(row.nw_rent) }}</td>
                    <td>${{ "{:,.0f}".format(row.home_value) }}</td>
                    <td>${{ "{:,.0f}".format(row.mortgage_balance) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="helper">Checkpoints include month 0, each anniversary, and the break-even month if it lands between years.</div>
        {% endif %}
      </div>
    {% endif %}
    {% if request.method == 'POST' %}
      <script>
        window.addEventListener('load', function () {
          var height = Math.max(
            document.body.scrollHeight,
            document.documentElement.scrollHeight,
            document.body.offsetHeight,
            document.documentElement.offsetHeight
          );
          window.scrollTo({ top: height, behavior: 'smooth' });
        });
      </script>
    {% endif %}
    <script>
      (function () {
        var priceEl = document.getElementById('purchase_price');
        var amountEl = document.getElementById('down_payment');
        var pctEl = document.getElementById('down_payment_pct');
        if (!priceEl || !amountEl || !pctEl) return;

        var lastEdited = 'amount';

        function parseNumber(raw) {
          if (raw == null) return NaN;
          var s = String(raw).trim();
          if (!s) return NaN;
          s = s.replace(/[$,%\s]/g, '');
          s = s.replace(/,/g, '');
          return Number(s);
        }

        function clampPct(p) {
          if (!Number.isFinite(p)) return NaN;
          return Math.max(0, Math.min(100, p));
        }

        function formatPct(p) {
          if (!Number.isFinite(p)) return '';
          var rounded = Math.round(p * 10) / 10;
          return String(rounded) + '%';
        }

        function formatDollars(n) {
          if (!Number.isFinite(n)) return '';
          return String(Math.round(n));
        }

        function syncFromAmount() {
          var price = parseNumber(priceEl.value);
          var amount = parseNumber(amountEl.value);
          if (!Number.isFinite(price) || price <= 0 || !Number.isFinite(amount)) {
            pctEl.value = '';
            return;
          }
          pctEl.value = formatPct((amount / price) * 100);
        }

        function enforcePctSuffix() {
          var v = String(pctEl.value || '').trim();
          if (!v) return;
          if (!v.endsWith('%')) pctEl.value = v.replace(/%/g, '') + '%';
          // Keep caret before the trailing % when editing.
          var pos = pctEl.value.length - 1;
          try { pctEl.setSelectionRange(pos, pos); } catch (e) {}
        }

        function syncFromPct() {
          var price = parseNumber(priceEl.value);
          var pct = clampPct(parseNumber(pctEl.value));
          if (!Number.isFinite(price) || price <= 0 || !Number.isFinite(pct)) return;
          amountEl.value = formatDollars((pct / 100) * price);
        }

        function syncOnPriceChange() {
          if (lastEdited === 'pct') syncFromPct();
          else syncFromAmount();
        }

        amountEl.addEventListener('input', function () {
          lastEdited = 'amount';
          syncFromAmount();
        });
        pctEl.addEventListener('input', function () {
          lastEdited = 'pct';
          enforcePctSuffix();
          syncFromPct();
        });
        pctEl.addEventListener('focus', enforcePctSuffix);
        pctEl.addEventListener('click', function () { enforcePctSuffix(); });
        priceEl.addEventListener('input', syncOnPriceChange);

        var form = document.getElementById('sim-form');
        if (form) {
          form.addEventListener('submit', function () {
            if (lastEdited === 'pct') syncFromPct();
            else syncFromAmount();
          });
        }

        syncFromAmount();
      })();
    </script>
    <script>
      (function () {
        function setMortgageMode(mode) {
          var fixedBlock = document.getElementById('fixed_rate_block');
          var variableBlock = document.getElementById('variable_rate_block');
          if (!fixedBlock || !variableBlock) return;
          if (mode === 'fixed') {
            fixedBlock.classList.remove('hide');
            variableBlock.classList.add('hide');
          } else {
            variableBlock.classList.remove('hide');
            fixedBlock.classList.add('hide');
          }
        }

        var variable = document.getElementById('rate_mode_variable');
        var fixed = document.getElementById('rate_mode_fixed');
        if (variable && fixed) {
          setMortgageMode(fixed.checked ? 'fixed' : 'variable');
          variable.addEventListener('change', function () { setMortgageMode('variable'); });
          fixed.addEventListener('change', function () { setMortgageMode('fixed'); });
        }
      })();
    </script>
  </body>
</html>
